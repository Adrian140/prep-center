name: Qogita Shipments Refresh

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      QOGITA_USER_ID: 8cb40471-22b2-404a-9531-385d7c554e47
    steps:
      - name: Fail fast on missing secrets
        if: ${{ env.SUPABASE_URL == '' || env.SUPABASE_SERVICE_ROLE == '' || env.QOGITA_USER_ID == '' }}
        run: |
          echo "Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE or QOGITA_USER_ID" >&2
          exit 1

      - name: Invoke qogita-shipments (pre-refresh tokens)
        run: |
          curl -s -X POST "$SUPABASE_URL/functions/v1/qogita-shipments" \
            -H "Content-Type: application/json" \
            -H "Authorization: $SUPABASE_SERVICE_ROLE" \
            -H "apikey: $SUPABASE_SERVICE_ROLE" \
            -d "{\"user_id\": \"$QOGITA_USER_ID\"}" \
            | tee /tmp/resp.json
          status=$?
          test $status -eq 0 || exit $status
