name: Sync Keepa Images Relauncher

on:
  workflow_run:
    workflows: ["Sync Keepa Images"]
    types: [completed]

permissions:
  contents: read
  actions: write

jobs:
  relaunch:
    runs-on: ubuntu-latest
    steps:
      - name: Relaunch keepa sync immediately
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const branch = context.payload.workflow_run.head_branch || '';
            const { data: repoData } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = String(repoData.default_branch || 'main');

            // Avoid loops from non-default branches, but allow empty head_branch
            // because canceled/timed-out runs can sometimes miss it.
            if (branch && branch !== defaultBranch) {
              core.info(`Run branch "${branch}" is not default branch "${defaultBranch}", skipping relaunch.`);
              return;
            }

            const workflowId = 'sync-keepa-images.yml';
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
              per_page: 10
            });

            const hasActive = (data.workflow_runs || []).some((run) =>
              run.id !== context.payload.workflow_run.id &&
              ['queued', 'in_progress', 'waiting', 'requested'].includes(run.status)
            );

            if (hasActive) {
              core.info('Există deja un run activ/în queue pentru Keepa; nu trimit altul.');
              return;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
              ref: defaultBranch
            });

            core.info('Run nou Keepa a fost trimis imediat după finalizarea precedentului.');
