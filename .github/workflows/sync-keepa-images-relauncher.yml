name: Sync Keepa Images Relauncher

on:
  workflow_run:
    workflows: ["Sync Keepa Images"]
    types: [completed]

permissions:
  contents: read
  actions: write

jobs:
  relaunch:
    # Prevent accidental loops from non-main branches.
    if: ${{ github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Relaunch keepa sync immediately
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const workflowId = 'sync-keepa-images.yml';
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
              per_page: 10
            });

            const hasActive = (data.workflow_runs || []).some((run) =>
              run.id !== context.payload.workflow_run.id &&
              ['queued', 'in_progress', 'waiting', 'requested'].includes(run.status)
            );

            if (hasActive) {
              core.info('Există deja un run activ/în queue pentru Keepa; nu trimit altul.');
              return;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
              ref: 'main'
            });

            core.info('Run nou Keepa a fost trimis imediat după finalizarea precedentului.');
